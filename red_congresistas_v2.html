<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Red de Conexiones: Congresistas, Familiares y Contratos Pﾃｺblicos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0c10;
            --bg-secondary: #13161c;
            --bg-card: #1a1e26;
            --bg-elevated: #242a35;
            --text-primary: #f5f7fa;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --accent-gold: #f59e0b;
            --accent-gold-light: #fbbf24;
            --accent-blue: #3b82f6;
            --accent-blue-light: #60a5fa;
            --accent-purple: #8b5cf6;
            --accent-purple-light: #a78bfa;
            --accent-green: #10b981;
            --accent-green-light: #34d399;
            --accent-red: #ef4444;
            --border-subtle: rgba(255,255,255,0.08);
            --border-hover: rgba(255,255,255,0.15);
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.4);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.5);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'DM Sans', sans-serif;
            background: #f1f0ea;
            color: var(--text-primary);
            min-height: 100vh;
            overflow: hidden;
        }
        
        /* ==================== HEADER ==================== */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 1rem 2rem;
            /*background: linear-gradient(180deg, var(--bg-primary) 0%, rgba(10,12,16,0.95) 70%, transparent 100%);*/
            background-color: transparent;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .header-left h1 {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-gold-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header-left p {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.2rem;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        /* ==================== SEARCH ==================== */
        .search-wrapper {
            position: relative;
        }
        
        .search-input {
            width: 280px;
            padding: 0.6rem 1rem 0.6rem 2.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.85rem;
            font-family: inherit;
            outline: none;
            transition: all 0.2s ease;
        }
        
        .search-input:focus {
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
        }
        
        .search-input::placeholder {
            color: var(--text-muted);
        }
        
        .search-icon {
            position: absolute;
            left: 0.8rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
        }
        
        /* ==================== SVG CONTAINER ==================== */
        #network-container {
            width: 100vw;
            height: 100vh;
            cursor: grab;
            background: 
                radial-gradient(ellipse at 20% 80%, rgba(59, 130, 246, 0.05) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(139, 92, 246, 0.05) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(245, 158, 11, 0.02) 0%, transparent 70%);
        }
        
        #network-container:active {
            cursor: grabbing;
        }
        
        /* ==================== NODES ==================== */
        .node {
            cursor: pointer;
            transition: opacity 0.4s ease, transform 0.2s ease;
        }
        
        .node:hover .node-circle {
            stroke-width: 3.5px;
        }
        
        .node-ring {
            fill: none;
            stroke-width: 2px;
            opacity: 0.6;
            transition: all 0.3s ease;
        }
        
        .node-circle {
            stroke-width: 2.5px;
            transition: all 0.3s ease;
        }
        
        /* Congresista */
        .node-congressperson .node-circle {
            fill: var(--bg-card);
            stroke: var(--accent-gold);
        }
        .node-congressperson .node-ring {
            stroke: var(--accent-gold);
            animation: pulse-ring 3s ease-out infinite;
        }
        
        /* Familiar */
        .node-familiar .node-circle {
            fill: var(--bg-card);
            stroke: var(--accent-blue);
        }
        .node-familiar .node-ring {
            stroke: var(--accent-blue);
        }
        
        /* Entidad */
        .node-entity .node-circle {
            fill: var(--bg-card);
            stroke: var(--accent-purple);
        }
        .node-entity .node-ring {
            stroke: var(--accent-purple);
        }
        
        /* Contrato */
        .node-contract .node-circle {
            fill: var(--bg-card);
            stroke: var(--accent-green);
        }
        .node-contract .node-ring {
            stroke: var(--accent-green);
        }
        
        /* Estados */
        .node.highlighted .node-circle {
            stroke-width: 4px;
            filter: drop-shadow(0 0 12px currentColor);
        }
        
        .node.highlighted .node-ring {
            opacity: 1;
            animation: pulse-ring-active 1.5s ease-out infinite;
        }
        
        .node.dimmed {
            opacity: 0.08;
        }
        
        .node-label {
            font-size: 10px;
            font-weight: 600;
            fill: var(--text-primary);
            text-anchor: middle;
            pointer-events: none;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
        }
        
        .node-sublabel {
            font-size: 8px;
            font-weight: 400;
            fill: var(--text-secondary);
            text-anchor: middle;
            pointer-events: none;
        }
        
        .node-icon {
            fill: var(--text-primary);
            pointer-events: none;
        }
        
        /* ==================== LINKS ==================== */
        .link {
            fill: none;
            stroke-linecap: round;
            transition: all 0.4s ease;
        }
        
        .link.highlighted {
            stroke-width: 3px !important;
            filter: drop-shadow(0 0 4px currentColor);
        }
        
        .link.dimmed {
            stroke-opacity: 0.03;
        }
        
        .link-congressperson-familiar {
            stroke: var(--accent-blue);
            stroke-width: 2px;
            stroke-opacity: 0.5;
        }
        
        .link-familiar-entity {
            stroke: var(--accent-purple);
            stroke-width: 1.5px;
            stroke-opacity: 0.4;
            stroke-dasharray: 4 2;
        }
        
        .link-entity-contract {
            stroke: var(--accent-green);
            stroke-width: 1px;
            stroke-opacity: 0.35;
        }
        
        /* ==================== TOOLTIP ==================== */
        .tooltip {
            position: fixed;
            background: var(--bg-card);
            border: 1px solid var(--border-hover);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            max-width: 340px;
            pointer-events: none;
            opacity: 0;
            transform: translateY(5px);
            transition: opacity 0.2s ease, transform 0.2s ease;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(10px);
        }
        
        .tooltip.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        .tooltip-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 600;
            padding: 0.25rem 0.6rem;
            border-radius: 4px;
            margin-bottom: 0.6rem;
        }
        
        .tooltip-badge.congressperson { background: rgba(245, 158, 11, 0.15); color: var(--accent-gold-light); }
        .tooltip-badge.familiar { background: rgba(59, 130, 246, 0.15); color: var(--accent-blue-light); }
        .tooltip-badge.entity { background: rgba(139, 92, 246, 0.15); color: var(--accent-purple-light); }
        .tooltip-badge.contract { background: rgba(16, 185, 129, 0.15); color: var(--accent-green-light); }
        
        .tooltip-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            line-height: 1.3;
        }
        
        .tooltip-grid {
            display: grid;
            gap: 0.4rem;
        }
        
        .tooltip-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 0.35rem 0;
            border-bottom: 1px solid var(--border-subtle);
            gap: 1rem;
        }
        
        .tooltip-row:last-child {
            border-bottom: none;
        }
        
        .tooltip-key {
            color: var(--text-muted);
            font-size: 0.75rem;
            flex-shrink: 0;
        }
        
        .tooltip-value {
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.8rem;
            text-align: right;
        }
        
        .tooltip-value.highlight {
            color: var(--accent-gold);
            font-weight: 700;
        }
        
        .tooltip-action {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            margin-top: 0.75rem;
            padding: 0.5rem 0.9rem;
            background: var(--accent-green);
            color: var(--bg-primary);
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.2s ease;
        }
        
        .tooltip-action:hover {
            background: var(--accent-green-light);
        }
        
        /* ==================== SIDEBAR ==================== */
        .sidebar {
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            width: 320px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-subtle);
            padding: 5rem 1.5rem 1.5rem;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 90;
            overflow-y: auto;
        }
        
        .sidebar.visible {
            transform: translateX(0);
        }
        
        .sidebar-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 32px;
            height: 32px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .sidebar-close:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }
        
        .sidebar-header {
            margin-bottom: 1.5rem;
        }
        
        .sidebar-badge {
            display: inline-block;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 600;
            padding: 0.25rem 0.6rem;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }
        
        .sidebar-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .sidebar-subtitle {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .sidebar-section {
            margin-bottom: 1.5rem;
        }
        
        .sidebar-section-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            font-weight: 600;
        }
        
        .sidebar-stat {
            display: flex;
            justify-content: space-between;
            padding: 0.6rem 0;
            border-bottom: 1px solid var(--border-subtle);
        }
        
        .sidebar-stat:last-child {
            border-bottom: none;
        }
        
        .sidebar-stat-value {
            font-weight: 700;
            color: var(--accent-gold);
        }
        
        .sidebar-connections {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .sidebar-connection {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.6rem 0.75rem;
            background: var(--bg-card);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .sidebar-connection:hover {
            background: var(--bg-elevated);
        }
        
        .sidebar-connection-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }
        
        .sidebar-connection-info {
            flex: 1;
            min-width: 0;
        }
        
        .sidebar-connection-name {
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .sidebar-connection-type {
            font-size: 0.7rem;
            color: var(--text-muted);
        }
        
        /* ==================== LEGEND ==================== */
        .legend {
            position: fixed;
            bottom: 1.5rem;
            left: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            background: rgba(26, 30, 38, 0.95);
            padding: 0.75rem 1.25rem;
            border-radius: 10px;
            border: 1px solid var(--border-subtle);
            backdrop-filter: blur(10px);
            z-index: 50;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .legend-dot.congressperson { background: var(--accent-gold); }
        .legend-dot.familiar { background: var(--accent-blue); }
        .legend-dot.entity { background: var(--accent-purple); }
        .legend-dot.contract { background: var(--accent-green); }
        
        /* ==================== CONTROLS ==================== */
        .controls {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            display: flex;
            gap: 0.5rem;
            z-index: 50;
        }
        
        .control-btn {
            width: 36px;
            height: 36px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-card);
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .control-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border-color: var(--border-hover);
        }
        
        .control-btn.active {
            background: var(--accent-gold);
            color: var(--bg-primary);
            border-color: var(--accent-gold);
        }
        
        /* ==================== STATS BAR ==================== */
        .stats-bar {
            position: fixed;
            bottom: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 2rem;
            background: rgba(26, 30, 38, 0.95);
            padding: 0.6rem 1.5rem;
            border-radius: 10px;
            border: 1px solid var(--border-subtle);
            backdrop-filter: blur(10px);
            z-index: 50;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .stat-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
        }
        
        /* ==================== ANIMATIONS ==================== */
        @keyframes pulse-ring {
            0% { r: 45; opacity: 0.6; }
            100% { r: 65; opacity: 0; }
        }
        
        @keyframes pulse-ring-active {
            0% { r: 45; opacity: 0.8; }
            100% { r: 75; opacity: 0; }
        }
        
        /* ==================== DATA LOADER ==================== */
        .loader-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        
        .loader-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loader-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-subtle);
            border-top-color: var(--accent-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loader-text {
            margin-top: 1rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ==================== FILE INPUT ==================== */
        .file-input-wrapper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .file-input-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .file-input-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }
        
        #file-input {
            display: none;
        }
        .file-input-wrapper {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Loader -->
    <div class="loader-overlay" id="loader">
        <div class="loader-spinner"></div>
        <p class="loader-text">Cargando visualizaciﾃｳn...</p>
    </div>
    
    <!-- Header -->
    <header class="header">
        <div class="header-left" style="opacity: 0;">
            <h1>Red de Conexiones</h1>
            <p>Congresistas, Familiares y Contratos con el Estado</p>
        </div>
        <div class="header-right">
            <div class="file-input-wrapper">
                <input type="file" id="file-input" accept=".json">
                <label for="file-input" class="file-input-btn">沒 Cargar JSON</label>
            </div>
            <div class="search-wrapper">
                <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                </svg>
                <input type="text" class="search-input" placeholder="Buscar por nombre, DNI o RUC..." id="search-input">
            </div>
        </div>
    </header>
    
    <!-- Main SVG -->
    <svg id="network-container"></svg>
    
    <!-- Tooltip -->
    <div class="tooltip" id="tooltip"></div>
    
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <button class="sidebar-close" id="sidebar-close">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
        </button>
        <div id="sidebar-content"></div>
    </aside>
    
    <!-- Legend -->
    <div class="legend">
        <div class="legend-item">
            <div class="legend-dot congressperson"></div>
            <span>Congresista</span>
        </div>
        <div class="legend-item">
            <div class="legend-dot familiar"></div>
            <span>Familiar</span>
        </div>
        <div class="legend-item">
            <div class="legend-dot entity"></div>
            <span>Entidad</span>
        </div>
        <div class="legend-item">
            <div class="legend-dot contract"></div>
            <span>Contrato</span>
        </div>
    </div>
    
    <!-- Stats Bar -->
    <div class="stats-bar" id="stats-bar">
        <div class="stat-item">
            <div class="stat-value" id="stat-congresspersons">0</div>
            <div class="stat-label">Congresistas</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="stat-familiars">0</div>
            <div class="stat-label">Familiares</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="stat-entities">0</div>
            <div class="stat-label">Entidades</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="stat-contracts">0</div>
            <div class="stat-label">Contratos</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="stat-total-amount">S/ 0</div>
            <div class="stat-label">Monto Total</div>
        </div>
    </div>
    
    <!-- Controls -->
    <div class="controls">
        <button class="control-btn" id="zoom-in" title="Acercar">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35M11 8v6M8 11h6"/>
            </svg>
        </button>
        <button class="control-btn" id="zoom-out" title="Alejar">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35M8 11h6"/>
            </svg>
        </button>
        <button class="control-btn" id="reset-view" title="Centrar vista">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/>
            </svg>
        </button>
        <button class="control-btn" id="clear-selection" title="Limpiar selecciﾃｳn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
        </button>
    </div>

    <script>
    // ============================================
    // CONFIGURACIﾃ哲 GLOBAL
    // ============================================
    const CONFIG = {
        nodeRadius: {
            congressperson: 40,
            familiar: 28,
            entity: 32,
            contract: 20
        },
        forces: {
            link: { distance: { 'congressperson-familiar': 140, 'familiar-entity': 110, 'entity-contract': 70 }, strength: 0.7 },
            charge: { congressperson: -700, familiar: -350, entity: -280, contract: -120 },
            collision: 25
        },
        colors: {
            congressperson: '#f59e0b',
            familiar: '#3b82f6',
            entity: '#8b5cf6',
            contract: '#10b981'
        },
        icons: {
            congressperson: '汨､',
            familiar: '汨･',
            entity: '沛｢',
            contract: '沒'
        }
    };

    // ============================================
    // DATOS DE EJEMPLO
    // ============================================
    const SAMPLE_DATA = {
        nodes: [
            // Congresistas
            { id: "C001", type: "congressperson", name: "Ana Marﾃｭa Zegarra Lﾃｳpez", dni: "42628319", party: "Alianza para el Progreso", commission: "Comisiﾃｳn de Economﾃｭa", department: "Lima", photo: "./img/ana-zegarra.png" },
            { id: "C002", type: "congressperson", name: "Josﾃｩ Luis Elﾃｭas ﾃ」alos", dni: "21569935", party: "Podemos Perﾃｺ", commission: "Comisiﾃｳn de Transportes", department: "Ica", photo: "./img/jose-luis-elias.png" },
            { id: "C003", type: "congressperson", name: "Patricia Rosa Chirinos Venegas", dni: "10280036", party: "Avanza Paﾃｭs", commission: "Junta de Portavoces", department: "Callao", photo: "./img/patricia-chirinos.png" },
            
            // Familiares - Ana Zegarra
            { id: "F001", type: "familiar", name: "Hugo Hermilio Alvarado Apaza", dni: "04632989", parentesco: "Padre del Cﾃｳnyuge", ocupacion: "Pescador Artesanal", congresspersonId: "C001" },
            { id: "F002", type: "familiar", name: "Josﾃｩ Alfredo Alvarado Mamani", dni: "40448882", parentesco: "Cuﾃｱado(a)", ocupacion: "Chofer", lugarTrabajo: "Transportes Halcon SRL", ruc: "20456789012", congresspersonId: "C001" },
            { id: "F003", type: "familiar", name: "Deisy Paola Alvarado Mamani", dni: "42067814", parentesco: "Cuﾃｱado(a)", ocupacion: "Promotora Educativa", lugarTrabajo: "Programa Educaciﾃｳn Bﾃ｡sica", congresspersonId: "C001" },
            
            // Familiares - Josﾃｩ Elﾃｭas
            { id: "F004", type: "familiar", name: "Carlos Elﾃｭas Mendoza", dni: "21234567", parentesco: "Hermano", ocupacion: "Gerente General", lugarTrabajo: "Constructora del Sur SAC", ruc: "20567891234", congresspersonId: "C002" },
            { id: "F005", type: "familiar", name: "Marﾃｭa Elena ﾃ」alos de Elﾃｭas", dni: "21345678", parentesco: "Madre", ocupacion: "Comerciante", lugarTrabajo: "Distribuidora ﾃ」alos EIRL", ruc: "20123456789", congresspersonId: "C002" },
            
            // Familiares - Patricia Chirinos
            { id: "F006", type: "familiar", name: "Ricardo Venegas Pﾃｩrez", dni: "10345678", parentesco: "Hermano", ocupacion: "Abogado", lugarTrabajo: "Estudio Venegas & Asociados", ruc: "20789012345", congresspersonId: "C003" },
            
            // Entidades
            { id: "E001", type: "entity", name: "Transportes Halcon SRL", ruc: "20456789012", rubro: "Transporte de carga", montoTotal: 1250000, numContratos: 8 },
            { id: "E002", type: "entity", name: "Constructora del Sur SAC", ruc: "20567891234", rubro: "Construcciﾃｳn", montoTotal: 4580000, numContratos: 12 },
            { id: "E003", type: "entity", name: "Distribuidora ﾃ」alos EIRL", ruc: "20123456789", rubro: "Comercializaciﾃｳn", montoTotal: 890000, numContratos: 5 },
            { id: "E004", type: "entity", name: "Estudio Venegas & Asociados", ruc: "20789012345", rubro: "Servicios legales", montoTotal: 560000, numContratos: 7 },
            
            // Contratos
            { id: "CT001", type: "contract", entidadId: "E001", fecha: "2023-05-15", descripcion: "Servicio de transporte de materiales para PRONIED", monto: 320000, entidadContratante: "PRONIED", documentUrl: "https://osce.gob.pe/doc/123" },
            { id: "CT002", type: "contract", entidadId: "E001", fecha: "2023-08-20", descripcion: "Transporte de equipos mﾃｩdicos - MINSA", monto: 185000, entidadContratante: "MINSA", documentUrl: "#" },
            { id: "CT003", type: "contract", entidadId: "E001", fecha: "2024-01-10", descripcion: "Distribuciﾃｳn de materiales educativos", monto: 245000, entidadContratante: "MINEDU", documentUrl: "#" },
            { id: "CT004", type: "contract", entidadId: "E002", fecha: "2023-03-10", descripcion: "Construcciﾃｳn de puente vehicular - Ica", monto: 2150000, entidadContratante: "MTC", documentUrl: "#" },
            { id: "CT005", type: "contract", entidadId: "E002", fecha: "2023-11-05", descripcion: "Mejoramiento de carretera regional", monto: 1850000, entidadContratante: "Gobierno Regional Ica", documentUrl: "#" },
            { id: "CT006", type: "contract", entidadId: "E003", fecha: "2024-01-15", descripcion: "Provisiﾃｳn de alimentos - Qali Warma", monto: 520000, entidadContratante: "Qali Warma", documentUrl: "#" },
            { id: "CT007", type: "contract", entidadId: "E004", fecha: "2023-06-20", descripcion: "Asesorﾃｭa legal para proceso de licitaciﾃｳn", monto: 180000, entidadContratante: "ESSALUD", documentUrl: "#" },
            { id: "CT008", type: "contract", entidadId: "E004", fecha: "2024-02-01", descripcion: "Servicios de consultorﾃｭa jurﾃｭdica", monto: 220000, entidadContratante: "Municipalidad del Callao", documentUrl: "#" }
        ],
        links: [
            // Congresista -> Familiares
            { source: "C001", target: "F001", type: "congressperson-familiar" },
            { source: "C001", target: "F002", type: "congressperson-familiar" },
            { source: "C001", target: "F003", type: "congressperson-familiar" },
            { source: "C002", target: "F004", type: "congressperson-familiar" },
            { source: "C002", target: "F005", type: "congressperson-familiar" },
            { source: "C003", target: "F006", type: "congressperson-familiar" },
            
            // Familiares -> Entidades
            { source: "F002", target: "E001", type: "familiar-entity" },
            { source: "F004", target: "E002", type: "familiar-entity" },
            { source: "F005", target: "E003", type: "familiar-entity" },
            { source: "F006", target: "E004", type: "familiar-entity" },
            
            // Entidades -> Contratos
            { source: "E001", target: "CT001", type: "entity-contract" },
            { source: "E001", target: "CT002", type: "entity-contract" },
            { source: "E001", target: "CT003", type: "entity-contract" },
            { source: "E002", target: "CT004", type: "entity-contract" },
            { source: "E002", target: "CT005", type: "entity-contract" },
            { source: "E003", target: "CT006", type: "entity-contract" },
            { source: "E004", target: "CT007", type: "entity-contract" },
            { source: "E004", target: "CT008", type: "entity-contract" }
        ]
    };

    // ============================================
    // CLASE PRINCIPAL
    // ============================================
    class NetworkVisualization {
        constructor(containerId, data) {
            this.container = d3.select(`#${containerId}`);
            this.data = this.processData(data);
            this.width = window.innerWidth;
            this.height = window.innerHeight;
            this.highlightedNodes = new Set();
            this.highlightedLinks = new Set();
            this.selectedNode = null;
            
            this.init();
        }
        
        processData(data) {
            // Crear copias para no mutar datos originales
            return {
                nodes: data.nodes.map(n => ({...n})),
                links: data.links.map(l => ({...l}))
            };
        }
        
        init() {
            this.setupSVG();
            this.setupDefs();
            this.setupSimulation();
            this.createLinks();
            this.createNodes();
            this.setupEvents();
            this.updateStats();
            this.hideLoader();
        }
        
        setupSVG() {
            this.container
                .attr('width', this.width)
                .attr('height', this.height);
            
            this.g = this.container.append('g');
            
            // Zoom
            this.zoom = d3.zoom()
                .scaleExtent([0.1, 5])
                .on('zoom', (event) => {
                    this.g.attr('transform', event.transform);
                });
            
            this.container.call(this.zoom);
        }
        
        setupDefs() {
            const defs = this.container.append('defs');
            
            // Patrones de fotos
            this.data.nodes
                .filter(n => n.type === 'congressperson' && n.photo)
                .forEach(node => {
                    const r = CONFIG.nodeRadius.congressperson;
                    defs.append('pattern')
                        .attr('id', `photo-${node.id}`)
                        .attr('patternUnits', 'objectBoundingBox')
                        .attr('width', 1)
                        .attr('height', 1)
                        .append('image')
                        .attr('xlink:href', node.photo)
                        .attr('width', r * 2)
                        .attr('height', r * 2)
                        .attr('preserveAspectRatio', 'xMidYMid slice');
                });
            
            // Gradientes para glow
            Object.entries(CONFIG.colors).forEach(([type, color]) => {
                const gradient = defs.append('radialGradient')
                    .attr('id', `glow-${type}`)
                    .attr('cx', '50%')
                    .attr('cy', '50%')
                    .attr('r', '50%');
                
                gradient.append('stop')
                    .attr('offset', '0%')
                    .attr('stop-color', color)
                    .attr('stop-opacity', 0.6);
                
                gradient.append('stop')
                    .attr('offset', '100%')
                    .attr('stop-color', color)
                    .attr('stop-opacity', 0);
            });
        }
        
        setupSimulation() {
            this.simulation = d3.forceSimulation(this.data.nodes)
                .force('link', d3.forceLink(this.data.links)
                    .id(d => d.id)
                    .distance(d => CONFIG.forces.link.distance[d.type] || 100)
                    .strength(CONFIG.forces.link.strength))
                .force('charge', d3.forceManyBody()
                    .strength(d => CONFIG.forces.charge[d.type] || -200))
                .force('center', d3.forceCenter(this.width / 2, this.height / 2))
                .force('collision', d3.forceCollide()
                    .radius(d => CONFIG.nodeRadius[d.type] + CONFIG.forces.collision))
                .force('x', d3.forceX(this.width / 2).strength(0.03))
                .force('y', d3.forceY(this.height / 2).strength(0.03))
                .alphaDecay(0.02)  // Mﾃ｡s estable
                .velocityDecay(0.4);  // Menos rebote
            
            this.simulation.on('tick', () => this.tick());
        }
        
        createLinks() {
            this.linkGroup = this.g.append('g').attr('class', 'links');
            
            this.links = this.linkGroup.selectAll('path')
                .data(this.data.links)
                .enter()
                .append('path')
                .attr('class', d => `link link-${d.type}`)
                .attr('data-source', d => d.source.id || d.source)
                .attr('data-target', d => d.target.id || d.target);
        }
        
        createNodes() {
            this.nodeGroup = this.g.append('g').attr('class', 'nodes');
            
            this.nodes = this.nodeGroup.selectAll('g')
                .data(this.data.nodes)
                .enter()
                .append('g')
                .attr('class', d => `node node-${d.type}`)
                .attr('data-id', d => d.id)
                .call(d3.drag()
                    .on('start', (event, d) => this.dragStarted(event, d))
                    .on('drag', (event, d) => this.dragged(event, d))
                    .on('end', (event, d) => this.dragEnded(event, d)));
            
            // Anillo exterior (para animaciﾃｳn pulse)
            this.nodes.append('circle')
                .attr('class', 'node-ring')
                .attr('r', d => CONFIG.nodeRadius[d.type] + 5);
            
            // Cﾃｭrculo principal
            this.nodes.append('circle')
                .attr('class', 'node-circle')
                .attr('r', d => CONFIG.nodeRadius[d.type]);
            
            // Contenido especﾃｭfico
            this.nodes.each((d, i, nodes) => {
                const node = d3.select(nodes[i]);
                const r = CONFIG.nodeRadius[d.type];
                
                if (d.type === 'congressperson' && d.photo) {
                    node.append('circle')
                        .attr('r', r - 4)
                        .attr('fill', `url(#photo-${d.id})`);
                } else {
                    node.append('text')
                        .attr('class', 'node-icon')
                        .attr('text-anchor', 'middle')
                        .attr('dominant-baseline', 'central')
                        .attr('font-size', d.type === 'contract' ? '14px' : '18px')
                        .text(CONFIG.icons[d.type]);
                }
                
                // Etiquetas
                const labelY = r + 14;
                node.append('text')
                    .attr('class', 'node-label')
                    .attr('y', labelY)
                    .text(this.truncateName(d.name || this.formatAmount(d.monto)));
                
                if (d.type !== 'contract') {
                    const sublabel = d.party || d.parentesco || d.rubro || '';
                    if (sublabel) {
                        node.append('text')
                            .attr('class', 'node-sublabel')
                            .attr('y', labelY + 12)
                            .text(this.truncateName(sublabel, 20));
                    }
                }
            });
        }
        
        tick() {
            this.links.attr('d', d => {
                const dx = d.target.x - d.source.x;
                const dy = d.target.y - d.source.y;
                const dr = Math.sqrt(dx * dx + dy * dy) * 1.5;
                return `M${d.source.x},${d.source.y}A${dr},${dr} 0 0,1 ${d.target.x},${d.target.y}`;
            });
            
            this.nodes.attr('transform', d => `translate(${d.x},${d.y})`);
        }
        
        setupEvents() {
            const self = this;
            
            // Hover y click en nodos
            this.nodes
                .on('mouseenter', function(event, d) {
                    // Fijar posiciﾃｳn temporalmente para evitar glitch
                    d._fx = d.fx;
                    d._fy = d.fy;
                    d.fx = d.x;
                    d.fy = d.y;
                    self.showTooltip(event, d);
                })
                .on('mouseleave', function(event, d) {
                    // Restaurar estado previo
                    d.fx = d._fx;
                    d.fy = d._fy;
                    delete d._fx;
                    delete d._fy;
                    self.hideTooltip();
                })
                .on('mousemove', function(event, d) {
                    // Actualizar posiciﾃｳn del tooltip al mover
                    self.updateTooltipPosition(event);
                })
                .on('click', function(event, d) {
                    event.stopPropagation();
                    self.selectNode(d);
                });
            
            // Click en fondo
            this.container.on('click', () => this.clearSelection());
            
            // Controles
            d3.select('#zoom-in').on('click', () => this.zoomIn());
            d3.select('#zoom-out').on('click', () => this.zoomOut());
            d3.select('#reset-view').on('click', () => this.resetView());
            d3.select('#clear-selection').on('click', () => this.clearSelection());
            
            // Sidebar
            d3.select('#sidebar-close').on('click', () => this.closeSidebar());
            
            // Bﾃｺsqueda
            d3.select('#search-input').on('input', function() {
                self.search(this.value);
            });
            
            // Cargar archivo
            d3.select('#file-input').on('change', function() {
                self.loadFile(this.files[0]);
            });
            
            // Resize
            window.addEventListener('resize', () => this.handleResize());
        }
        
        // ==================== INTERACCIONES ====================
        
        selectNode(d) {
            this.selectedNode = d;
            this.highlightConnections(d);
            this.showSidebar(d);
        }
        
        highlightConnections(d) {
            this.highlightedNodes.clear();
            this.highlightedLinks.clear();
            
            const findConnections = (nodeId, visited = new Set()) => {
                if (visited.has(nodeId)) return;
                visited.add(nodeId);
                this.highlightedNodes.add(nodeId);
                
                this.data.links.forEach(link => {
                    const sourceId = link.source.id || link.source;
                    const targetId = link.target.id || link.target;
                    
                    if (sourceId === nodeId || targetId === nodeId) {
                        this.highlightedLinks.add(`${sourceId}-${targetId}`);
                        findConnections(sourceId === nodeId ? targetId : sourceId, visited);
                    }
                });
            };
            
            findConnections(d.id);
            this.applyHighlight();
        }
        
        applyHighlight() {
            this.nodes
                .classed('highlighted', n => this.highlightedNodes.has(n.id))
                .classed('dimmed', n => this.highlightedNodes.size > 0 && !this.highlightedNodes.has(n.id));
            
            this.links
                .classed('highlighted', l => {
                    const key = `${l.source.id || l.source}-${l.target.id || l.target}`;
                    return this.highlightedLinks.has(key);
                })
                .classed('dimmed', l => {
                    if (this.highlightedLinks.size === 0) return false;
                    const key = `${l.source.id || l.source}-${l.target.id || l.target}`;
                    return !this.highlightedLinks.has(key);
                });
        }
        
        clearSelection() {
            this.selectedNode = null;
            this.highlightedNodes.clear();
            this.highlightedLinks.clear();
            this.applyHighlight();
            this.closeSidebar();
        }
        
        // ==================== TOOLTIP ====================
        
        showTooltip(event, d) {
            const tooltip = d3.select('#tooltip');
            let content = `<span class="tooltip-badge ${d.type}">${this.getTypeLabel(d.type)}</span>`;
            content += `<div class="tooltip-title">${d.name || this.formatAmount(d.monto)}</div>`;
            content += '<div class="tooltip-grid">';
            
            const rows = this.getTooltipRows(d);
            rows.forEach(([key, value, highlight]) => {
                content += `<div class="tooltip-row">
                    <span class="tooltip-key">${key}</span>
                    <span class="tooltip-value${highlight ? ' highlight' : ''}">${value}</span>
                </div>`;
            });
            
            content += '</div>';
            
            if (d.documentUrl && d.documentUrl !== '#') {
                content += `<a href="${d.documentUrl}" class="tooltip-action" target="_blank">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                        <polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/>
                    </svg>
                    Ver documento
                </a>`;
            }
            
            tooltip.html(content);
            
            // Calcular posiciﾃｳn para evitar que salga de la pantalla
            const tooltipNode = tooltip.node();
            const tooltipRect = tooltipNode.getBoundingClientRect();
            let left = event.pageX + 20;
            let top = event.pageY - 10;
            
            // Ajustar si sale por la derecha
            if (left + tooltipRect.width > window.innerWidth - 20) {
                left = event.pageX - tooltipRect.width - 20;
            }
            
            // Ajustar si sale por abajo
            if (top + tooltipRect.height > window.innerHeight - 20) {
                top = window.innerHeight - tooltipRect.height - 20;
            }
            
            // Ajustar si sale por arriba
            if (top < 20) {
                top = 20;
            }
            
            tooltip
                .style('left', `${left}px`)
                .style('top', `${top}px`)
                .classed('visible', true);
        }
        
        hideTooltip() {
            d3.select('#tooltip').classed('visible', false);
        }
        
        updateTooltipPosition(event) {
            const tooltip = d3.select('#tooltip');
            if (tooltip.classed('visible')) {
                const tooltipNode = tooltip.node();
                const tooltipRect = tooltipNode.getBoundingClientRect();
                let left = event.pageX + 20;
                let top = event.pageY - 10;
                
                if (left + tooltipRect.width > window.innerWidth - 20) {
                    left = event.pageX - tooltipRect.width - 20;
                }
                if (top + tooltipRect.height > window.innerHeight - 20) {
                    top = window.innerHeight - tooltipRect.height - 20;
                }
                if (top < 20) top = 20;
                
                tooltip
                    .style('left', `${left}px`)
                    .style('top', `${top}px`);
            }
        }
        
        getTooltipRows(d) {
            const rows = [];
            switch (d.type) {
                case 'congressperson':
                    rows.push(['DNI', d.dni]);
                    rows.push(['Partido', d.party]);
                    if (d.commission) rows.push(['Comisiﾃｳn', d.commission]);
                    if (d.department) rows.push(['Departamento', d.department]);
                    break;
                case 'familiar':
                    rows.push(['DNI', d.dni]);
                    rows.push(['Parentesco', d.parentesco]);
                    rows.push(['Ocupaciﾃｳn', d.ocupacion]);
                    if (d.lugarTrabajo) rows.push(['Lugar de trabajo', d.lugarTrabajo]);
                    if (d.ruc) rows.push(['RUC empresa', d.ruc]);
                    break;
                case 'entity':
                    rows.push(['RUC', d.ruc]);
                    rows.push(['Rubro', d.rubro]);
                    rows.push(['Monto total', this.formatAmount(d.montoTotal), true]);
                    rows.push(['Nﾂｰ contratos', d.numContratos]);
                    break;
                case 'contract':
                    rows.push(['Fecha', this.formatDate(d.fecha)]);
                    rows.push(['Descripciﾃｳn', d.descripcion]);
                    rows.push(['Monto', this.formatAmount(d.monto), true]);
                    rows.push(['Entidad', d.entidadContratante]);
                    break;
            }
            return rows;
        }
        
        // ==================== SIDEBAR ====================
        
        showSidebar(d) {
            const sidebar = d3.select('#sidebar');
            const content = d3.select('#sidebar-content');
            
            // Badge y tﾃｭtulo
            let html = `
                <div class="sidebar-header">
                    <span class="sidebar-badge tooltip-badge ${d.type}">${this.getTypeLabel(d.type)}</span>
                    <h2 class="sidebar-title">${d.name || this.formatAmount(d.monto)}</h2>
                    <p class="sidebar-subtitle">${d.party || d.parentesco || d.rubro || d.entidadContratante || ''}</p>
                </div>
            `;
            
            // Informaciﾃｳn detallada
            html += '<div class="sidebar-section"><h3 class="sidebar-section-title">Informaciﾃｳn</h3>';
            const rows = this.getTooltipRows(d);
            rows.forEach(([key, value, highlight]) => {
                html += `<div class="sidebar-stat">
                    <span>${key}</span>
                    <span class="sidebar-stat-value" style="${highlight ? '' : 'color: var(--text-primary)'}">${value}</span>
                </div>`;
            });
            html += '</div>';
            
            // Conexiones
            const connections = this.getConnections(d);
            if (connections.length > 0) {
                html += '<div class="sidebar-section"><h3 class="sidebar-section-title">Conexiones</h3>';
                html += '<div class="sidebar-connections">';
                connections.forEach(conn => {
                    const bgColor = `rgba(${this.hexToRgb(CONFIG.colors[conn.type])}, 0.15)`;
                    html += `<div class="sidebar-connection" data-id="${conn.id}">
                        <div class="sidebar-connection-icon" style="background: ${bgColor}">${CONFIG.icons[conn.type]}</div>
                        <div class="sidebar-connection-info">
                            <div class="sidebar-connection-name">${conn.name || this.formatAmount(conn.monto)}</div>
                            <div class="sidebar-connection-type">${this.getTypeLabel(conn.type)}</div>
                        </div>
                    </div>`;
                });
                html += '</div></div>';
            }
            
            content.html(html);
            sidebar.classed('visible', true);
            
            // Click en conexiones
            const self = this;
            content.selectAll('.sidebar-connection').on('click', function() {
                const id = this.getAttribute('data-id');
                const node = self.data.nodes.find(n => n.id === id);
                if (node) self.selectNode(node);
            });
        }
        
        closeSidebar() {
            d3.select('#sidebar').classed('visible', false);
        }
        
        getConnections(d) {
            const connected = [];
            this.data.links.forEach(link => {
                const sourceId = link.source.id || link.source;
                const targetId = link.target.id || link.target;
                
                if (sourceId === d.id) {
                    const node = this.data.nodes.find(n => n.id === targetId);
                    if (node) connected.push(node);
                } else if (targetId === d.id) {
                    const node = this.data.nodes.find(n => n.id === sourceId);
                    if (node) connected.push(node);
                }
            });
            return connected;
        }
        
        // ==================== CONTROLES ====================
        
        zoomIn() {
            this.container.transition().call(this.zoom.scaleBy, 1.4);
        }
        
        zoomOut() {
            this.container.transition().call(this.zoom.scaleBy, 0.7);
        }
        
        resetView() {
            this.container.transition().duration(750).call(
                this.zoom.transform,
                d3.zoomIdentity.translate(0, 0).scale(1)
            );
        }
        
        search(query) {
            query = query.toLowerCase().trim();
            
            if (!query) {
                this.clearSelection();
                return;
            }
            
            const matches = this.data.nodes.filter(n =>
                (n.name && n.name.toLowerCase().includes(query)) ||
                (n.dni && n.dni.includes(query)) ||
                (n.ruc && n.ruc.includes(query))
            );
            
            if (matches.length > 0) {
                this.selectNode(matches[0]);
                // Centrar en el nodo
                const node = matches[0];
                const transform = d3.zoomIdentity
                    .translate(this.width / 2 - node.x, this.height / 2 - node.y);
                this.container.transition().duration(500).call(this.zoom.transform, transform);
            }
        }
        
        // ==================== DATOS ====================
        
        loadFile(file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    this.reloadData(data);
                } catch (err) {
                    alert('Error al cargar el archivo JSON: ' + err.message);
                }
            };
            reader.readAsText(file);
        }
        
        reloadData(data) {
            // Limpiar
            this.g.selectAll('*').remove();
            this.simulation.stop();
            
            // Recargar
            this.data = this.processData(data);
            this.setupDefs();
            this.setupSimulation();
            this.createLinks();
            this.createNodes();
            this.updateStats();
            this.clearSelection();
        }
        
        updateStats() {
            const counts = { congressperson: 0, familiar: 0, entity: 0, contract: 0 };
            let totalAmount = 0;
            
            this.data.nodes.forEach(n => {
                counts[n.type]++;
                if (n.type === 'contract' && n.monto) totalAmount += n.monto;
            });
            
            d3.select('#stat-congresspersons').text(counts.congressperson);
            d3.select('#stat-familiars').text(counts.familiar);
            d3.select('#stat-entities').text(counts.entity);
            d3.select('#stat-contracts').text(counts.contract);
            d3.select('#stat-total-amount').text(this.formatAmount(totalAmount));
        }
        
        // ==================== UTILIDADES ====================
        
        dragStarted(event, d) {
            if (!event.active) this.simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
            // Ocultar tooltip durante drag
            this.hideTooltip();
        }
        
        dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }
        
        dragEnded(event, d) {
            if (!event.active) this.simulation.alphaTarget(0);
            // Solo liberar si no estaba fijado por hover
            if (!d._fx && !d._fy) {
                d.fx = null;
                d.fy = null;
            }
        }
        
        handleResize() {
            this.width = window.innerWidth;
            this.height = window.innerHeight;
            this.container.attr('width', this.width).attr('height', this.height);
            this.simulation.force('center', d3.forceCenter(this.width / 2, this.height / 2));
            this.simulation.alpha(0.3).restart();
        }
        
        hideLoader() {
            setTimeout(() => {
                d3.select('#loader').classed('hidden', true);
            }, 500);
        }
        
        getTypeLabel(type) {
            const labels = {
                congressperson: 'Congresista',
                familiar: 'Familiar',
                entity: 'Entidad',
                contract: 'Contrato'
            };
            return labels[type] || type;
        }
        
        formatAmount(amount) {
            if (!amount) return 'S/ 0';
            return `S/ ${amount.toLocaleString('es-PE', { minimumFractionDigits: 0 })}`;
        }
        
        formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleDateString('es-PE', { year: 'numeric', month: 'short', day: 'numeric' });
        }
        
        truncateName(name, maxLen = 25) {
            if (!name) return '';
            return name.length > maxLen ? name.substring(0, maxLen - 2) + '...' : name;
        }
        
        hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? 
                `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : 
                '255, 255, 255';
        }
    }

    // ============================================
    // INICIALIZAR
    // ============================================
    document.addEventListener('DOMContentLoaded', () => {
        window.networkViz = new NetworkVisualization('network-container', SAMPLE_DATA);
    });
    </script>
</body>
</html>